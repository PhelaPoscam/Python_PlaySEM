<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PythonPlaySEM Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #10b981;
        }

        .status-dot.disconnected {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #f3f4f6;
            padding-bottom: 10px;
        }

        .device-list {
            list-style: none;
        }

        .device-item {
            padding: 10px;
            margin: 8px 0;
            background: #f9fafb;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .device-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }

        .device-info {
            display: flex;
            flex-direction: column;
        }

        .device-name {
            font-weight: bold;
            color: #1f2937;
        }

        .device-type {
            font-size: 0.85em;
            color: #6b7280;
        }

        .device-actions {
            display: flex;
            gap: 8px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button.danger {
            background: #ef4444;
        }

        button.danger:hover {
            background: #dc2626;
        }

        button.success {
            background: #10b981;
        }

        button.success:hover {
            background: #059669;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #4b5563;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 0.95em;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .slider-container {
            margin: 15px 0;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e5e7eb;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .slider-value {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin-top: 5px;
        }

        .log-container {
            background: #1f2937;
            color: #f9fafb;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #374151;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-timestamp {
            color: #9ca3af;
        }

        .log-type {
            font-weight: bold;
            margin: 0 8px;
        }

        .log-type.info { color: #3b82f6; }
        .log-type.success { color: #10b981; }
        .log-type.error { color: #ef4444; }
        .log-type.warning { color: #f59e0b; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .discovery-section {
            margin-top: 15px;
            padding: 15px;
            background: #fef3c7;
            border-radius: 5px;
            border-left: 4px solid #f59e0b;
        }

        .discovery-section h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .effect-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .preset-btn {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .preset-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÆ PythonPlaySEM Control Panel</h1>
            <p>Real-time device control and effect testing</p>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot disconnected" id="connectionStatus"></div>
                    <span id="connectionText">Disconnected</span>
                </div>
                <div class="status-item">
                    <span>Server: <strong id="serverUrl">Not connected</strong></span>
                </div>
                <div class="status-item">
                    <span>Active Devices: <strong id="deviceCount">0</strong></span>
                </div>
            </div>
        </header>

        <div id="alertContainer"></div>

        <div class="grid">
            <!-- Connection Panel -->
            <div class="card">
                <h2>üîå Control Panel Connection</h2>
                <div class="form-group">
                    <label for="serverHost">Control Panel Server Host</label>
                    <input type="text" id="serverHost" value="localhost" placeholder="localhost or IP">
                </div>
                <div class="form-group">
                    <label for="serverPort">Port</label>
                    <input type="number" id="serverPort" value="8090" placeholder="8090">
                </div>
                <div style="font-size:12px;color:#666;margin-bottom:10px;">
                    Note: This connects the web UI to the control panel backend via WebSocket.
                </div>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="phoneMode">
                        <span>üì≥ Phone mode: vibrate on incoming vibration effects</span>
                    </label>
                    <div style="font-size:12px;color:#666;margin-top:6px;">Open this page on your phone and check this box to vibrate when the server broadcasts a vibration effect.</div>
                </div>
                <button onclick="connectToServer()" id="connectBtn">Connect</button>
                <button onclick="disconnectFromServer()" class="danger" id="disconnectBtn" disabled>Disconnect</button>
            </div>

            <!-- Device Discovery -->
            <div class="card">
                <h2>üîç Device Discovery</h2>
                <div class="form-group">
                    <label for="driverType">Device Connection Type</label>
                    <select id="driverType">
                        <option value="mock">Mock (Testing without hardware)</option>
                        <option value="bluetooth">Bluetooth BLE (Wireless devices)</option>
                        <option value="serial">Serial USB (Arduino, ESP32, etc.)</option>
                        <option value="mqtt">MQTT (Connect to MQTT broker)</option>
                    </select>
                </div>
                <div style="font-size:12px;color:#666;margin-bottom:10px;">
                    This selects HOW PlaySEM connects to physical/virtual devices
                </div>
                <button onclick="scanDevices()" class="success">
                    <span id="scanIcon">üîç</span> Scan for Devices
                </button>
                <div class="discovery-section" id="discoveryResults" style="display: none;">
                    <h3>Discovered Devices</h3>
                    <ul class="device-list" id="discoveredDevicesList"></ul>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Connected Devices -->
            <div class="card">
                <h2>üì± Connected Devices</h2>
                <ul class="device-list" id="deviceList">
                    <li class="device-item">
                        <div class="device-info">
                            <span class="device-name">No devices connected</span>
                            <span class="device-type">Connect a device to get started</span>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- Protocol Servers -->
            <div class="card">
                <h2>üì° Protocol Servers</h2>
                <div style="font-size:12px;color:#666;margin-bottom:15px;">
                    Start protocol servers to allow external clients to send effects to PlaySEM
                </div>
                
                <div class="protocol-server-item" style="margin-bottom:10px;padding:10px;background:#f9fafb;border-radius:5px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <strong>MQTT Server</strong>
                            <div style="font-size:11px;color:#666;">test.mosquitto.org:1883</div>
                        </div>
                        <div>
                            <span id="mqttStatus" style="font-size:12px;color:#666;">Stopped</span>
                            <button onclick="toggleProtocolServer('mqtt')" id="mqttBtn" style="margin-left:10px;">Start</button>
                        </div>
                    </div>
                </div>
                
                <div class="protocol-server-item" style="margin-bottom:10px;padding:10px;background:#f9fafb;border-radius:5px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <strong>CoAP Server</strong>
                            <div style="font-size:11px;color:#666;">127.0.0.1:5683</div>
                        </div>
                        <div>
                            <span id="coapStatus" style="font-size:12px;color:#666;">Stopped</span>
                            <button onclick="toggleProtocolServer('coap')" id="coapBtn" style="margin-left:10px;">Start</button>
                        </div>
                    </div>
                </div>
                
                <div class="protocol-server-item" style="margin-bottom:10px;padding:10px;background:#f9fafb;border-radius:5px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <strong>HTTP REST API</strong>
                            <div style="font-size:11px;color:#666;">Port: 8081</div>
                        </div>
                        <div>
                            <span id="httpStatus" style="font-size:12px;color:#666;">Stopped</span>
                            <button onclick="toggleProtocolServer('http')" id="httpBtn" style="margin-left:10px;">Start</button>
                        </div>
                    </div>
                </div>
                
                <div class="protocol-server-item" style="margin-bottom:10px;padding:10px;background:#f9fafb;border-radius:5px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <strong>UPnP Discovery</strong>
                            <div style="font-size:11px;color:#666;">SSDP Multicast</div>
                        </div>
                        <div>
                            <span id="upnpStatus" style="font-size:12px;color:#666;">Stopped</span>
                            <button onclick="toggleProtocolServer('upnp')" id="upnpBtn" style="margin-left:10px;">Start</button>
                        </div>
                    </div>
                </div>
                
                <div class="protocol-server-item" style="padding:10px;background:#f9fafb;border-radius:5px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <strong>WebSocket SEM Server</strong>
                            <div style="font-size:11px;color:#666;">Port: 8765</div>
                        </div>
                        <div>
                            <span id="websocketStatus" style="font-size:12px;color:#666;">Stopped</span>
                            <button onclick="toggleProtocolServer('websocket')" id="websocketBtn" style="margin-left:10px;">Start</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- System Stats -->
            <div class="card">
                <h2>üìä System Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="effectsSent">0</div>
                        <div class="stat-label">Effects Sent</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgLatency">0ms</div>
                        <div class="stat-label">Avg Latency</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="uptime">00:00:00</div>
                        <div class="stat-label">Uptime</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="errorCount">0</div>
                        <div class="stat-label">Errors</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Effect Testing -->
            <div class="card">
                <h2>‚ö° Effect Testing</h2>
                <div class="form-group">
                    <label for="targetDevice">Target Device</label>
                    <select id="targetDevice">
                        <option value="">Select a device...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="effectType">Effect Type</label>
                    <select id="effectType">
                        <option value="vibration">Vibration</option>
                        <option value="light">Light</option>
                        <option value="wind">Wind</option>
                        <option value="scent">Scent</option>
                        <option value="temperature">Temperature</option>
                    </select>
                </div>
                <div class="slider-container">
                    <label for="intensity">Intensity: <span id="intensityValue">50</span>%</label>
                    <input type="range" id="intensity" min="0" max="100" value="50" 
                           oninput="document.getElementById('intensityValue').textContent = this.value">
                </div>
                <div class="slider-container">
                    <label for="duration">Duration: <span id="durationValue">1000</span>ms</label>
                    <input type="range" id="duration" min="100" max="5000" value="1000" step="100"
                           oninput="document.getElementById('durationValue').textContent = this.value">
                </div>
                <button onclick="sendEffect()" class="success">Send Effect</button>

                <h3 style="margin-top: 20px; color: #667eea;">Quick Presets</h3>
                <div class="effect-presets">
                    <button class="preset-btn" onclick="sendPreset('short')">Short Buzz<br>20% / 200ms</button>
                    <button class="preset-btn" onclick="sendPreset('medium')">Medium Pulse<br>50% / 1s</button>
                    <button class="preset-btn" onclick="sendPreset('strong')">Strong Vibe<br>80% / 2s</button>
                    <button class="preset-btn" onclick="sendPreset('max')">Maximum<br>100% / 3s</button>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="card">
                <h2>üìù Activity Log</h2>
                <button onclick="clearLog()" class="danger" style="float: right; margin-top: -35px;">Clear Log</button>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-timestamp">[00:00:00]</span>
                        <span class="log-type info">[INFO]</span>
                        <span>Control panel initialized</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let connection = null;
        let stats = {
            effectsSent: 0,
            totalLatency: 0,
            errors: 0,
            startTime: Date.now()
        };

        // Update uptime counter
        setInterval(() => {
            const elapsed = Date.now() - stats.startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('uptime').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }, 1000);

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-type ${type}">[${type.toUpperCase()}]</span>
                <span>${message}</span>
            `;
            logContainer.insertBefore(entry, logContainer.firstChild);
            
            // Keep only last 50 entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function connectToServer() {
            const host = document.getElementById('serverHost').value;
            const port = document.getElementById('serverPort').value;
            
            log('Connecting to control panel backend...', 'info');
            connectWebSocket(host, port);
        }
        
        function connectWebSocket(host, port) {
            const url = `ws://${host}:${port}/ws`;
            connection = new WebSocket(url);
            
            connection.onopen = () => {
                log('WebSocket connected', 'success');
                showAlert('Successfully connected via WebSocket!', 'success');
                updateConnectionStatus(true, url);
                sendMessage({type: 'get_devices'});
            };
            
            connection.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleServerMessage(data);
            };
            
            connection.onerror = (error) => {
                log('WebSocket error: ' + error, 'error');
                showAlert('WebSocket connection error!', 'error');
                stats.errors++;
                updateStats();
            };
            
            connection.onclose = () => {
                log('WebSocket disconnected', 'warning');
                updateConnectionStatus(false, '');
            };
        }
        
        
        function updateConnectionStatus(connected, url) {
            document.getElementById('connectionStatus').className = 
                `status-dot ${connected ? 'connected' : 'disconnected'}`;
            document.getElementById('connectionText').textContent = 
                connected ? 'Connected' : 'Disconnected';
            document.getElementById('serverUrl').textContent = 
                connected ? url : 'Not connected';
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
        }

        function disconnectFromServer() {
            if (connection && connection.close) {
                connection.close();
                connection = null;
                log('Disconnecting...', 'info');
                updateConnectionStatus(false, '');
            }
        }

        function sendMessage(data) {
            if (!connection) {
                showAlert('Not connected to server!', 'error');
                return;
            }
            
            if (connection.readyState === WebSocket.OPEN) {
                connection.send(JSON.stringify(data));
            } else {
                showAlert('WebSocket not ready!', 'error');
            }
        }

        function handleServerMessage(data) {
            log(`Received: ${data.type}`, 'info');
            
            switch(data.type) {
                case 'device_list':
                    updateDeviceList(data.devices);
                    break;
                case 'device_discovered':
                    addDiscoveredDevice(data.device);
                    break;
                case 'effect_result':
                    if (data.success) {
                        showAlert('Effect sent successfully!', 'success');
                        stats.effectsSent++;
                        stats.totalLatency += data.latency || 0;
                        updateStats();
                    } else {
                        showAlert('Effect failed: ' + data.error, 'error');
                        stats.errors++;
                        updateStats();
                    }
                    break;
                case 'effect_executed':
                    // If phone mode is enabled, vibrate on executed vibration effects
                    try {
                        const phoneMode = document.getElementById('phoneMode').checked;
                        if (phoneMode) {
                            const et = data.effect_type || data.type;
                            if (et === 'vibration' || et === 'effect_vibration') {
                                if ('vibrate' in navigator && typeof data.duration === 'number') {
                                    navigator.vibrate(data.duration);
                                    showAlert('Phone vibrate: ' + data.duration + 'ms', 'success');
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('Vibrate failed', e);
                    }
                    break;
                case 'protocol_status':
                    updateProtocolStatus(data.protocol, data.running, data.error);
                    break;
                case 'stats':
                    updateSystemStats(data.stats);
                    break;
            }
        }

        function updateProtocolStatus(protocol, running, error) {
            const statusElement = document.getElementById(`${protocol}Status`);
            const btnElement = document.getElementById(`${protocol}Btn`);
            
            if (error) {
                statusElement.textContent = 'Error';
                statusElement.style.color = '#e11d48';
                showAlert(`${protocol.toUpperCase()} server error: ${error}`, 'error');
            } else if (running) {
                statusElement.textContent = 'Running';
                statusElement.style.color = '#16a34a';
                btnElement.textContent = 'Stop';
                log(`${protocol.toUpperCase()} server started successfully`, 'success');
            } else {
                statusElement.textContent = 'Stopped';
                statusElement.style.color = '#666';
                btnElement.textContent = 'Start';
                log(`${protocol.toUpperCase()} server stopped`, 'info');
            }
        }

        function updateDeviceList(devices) {
            const deviceList = document.getElementById('deviceList');
            const targetDevice = document.getElementById('targetDevice');
            
            deviceList.innerHTML = '';
            targetDevice.innerHTML = '<option value="">Select a device...</option>';
            
            if (devices.length === 0) {
                deviceList.innerHTML = `
                    <li class="device-item">
                        <div class="device-info">
                            <span class="device-name">No devices connected</span>
                            <span class="device-type">Scan for devices to connect</span>
                        </div>
                    </li>
                `;
            } else {
                devices.forEach(device => {
                    const li = document.createElement('li');
                    li.className = 'device-item';
                    li.innerHTML = `
                        <div class="device-info">
                            <span class="device-name">${device.name}</span>
                            <span class="device-type">${device.type} - ${device.address}</span>
                        </div>
                        <div class="device-actions">
                            <button onclick="testDevice('${device.id}')">Test</button>
                            <button class="danger" onclick="disconnectDevice('${device.id}')">Disconnect</button>
                        </div>
                    `;
                    deviceList.appendChild(li);
                    
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.textContent = device.name;
                    targetDevice.appendChild(option);
                });
            }
            
            document.getElementById('deviceCount').textContent = devices.length;
        }

        function scanDevices() {
            const driverType = document.getElementById('driverType').value;
            log(`Scanning for ${driverType} devices...`, 'info');
            document.getElementById('scanIcon').textContent = '‚è≥';
            
            sendMessage({
                type: 'scan_devices',
                driver_type: driverType
            });
            
            document.getElementById('discoveryResults').style.display = 'block';
            document.getElementById('discoveredDevicesList').innerHTML = '<li class="device-item">Scanning...</li>';
            
            setTimeout(() => {
                document.getElementById('scanIcon').textContent = 'üîç';
            }, 3000);
        }

        function addDiscoveredDevice(device) {
            const list = document.getElementById('discoveredDevicesList');
            if (list.children[0]?.textContent === 'Scanning...') {
                list.innerHTML = '';
            }
            
            const li = document.createElement('li');
            li.className = 'device-item';
            li.innerHTML = `
                <div class="device-info">
                    <span class="device-name">${device.name}</span>
                    <span class="device-type">${device.address} - ${device.rssi || 'N/A'}</span>
                </div>
                <div class="device-actions">
                    <button class="success" onclick="connectDevice('${device.address}', '${device.type}')">Connect</button>
                </div>
            `;
            list.appendChild(li);
        }

        function connectDevice(address, type) {
            log(`Connecting to ${address}...`, 'info');
            sendMessage({
                type: 'connect_device',
                address: address,
                driver_type: type
            });
        }

        function disconnectDevice(deviceId) {
            log(`Disconnecting device ${deviceId}...`, 'info');
            sendMessage({
                type: 'disconnect_device',
                device_id: deviceId
            });
        }

        function testDevice(deviceId) {
            log(`Testing device ${deviceId}...`, 'info');
            sendMessage({
                type: 'send_effect',
                device_id: deviceId,
                effect: {
                    effect_type: 'vibration',
                    intensity: 50,
                    duration: 500
                }
            });
        }

        function sendEffect() {
            const deviceId = document.getElementById('targetDevice').value;
            const effectType = document.getElementById('effectType').value;
            const intensity = parseInt(document.getElementById('intensity').value);
            const duration = parseInt(document.getElementById('duration').value);
            
            if (!deviceId) {
                showAlert('Please select a target device!', 'error');
                return;
            }
            
            log(`Sending ${effectType} effect (${intensity}%, ${duration}ms) to device ${deviceId}`, 'info');
            
            sendMessage({
                type: 'send_effect',
                device_id: deviceId,
                effect: {
                    effect_type: effectType,
                    intensity: intensity,
                    duration: duration
                }
            });
        }

        function sendPreset(preset) {
            const presets = {
                short: { intensity: 20, duration: 200 },
                medium: { intensity: 50, duration: 1000 },
                strong: { intensity: 80, duration: 2000 },
                max: { intensity: 100, duration: 3000 }
            };
            
            const config = presets[preset];
            document.getElementById('intensity').value = config.intensity;
            document.getElementById('duration').value = config.duration;
            document.getElementById('intensityValue').textContent = config.intensity;
            document.getElementById('durationValue').textContent = config.duration;
            
            setTimeout(() => sendEffect(), 100);
        }

        function toggleProtocolServer(protocol) {
            const statusElement = document.getElementById(`${protocol}Status`);
            const btnElement = document.getElementById(`${protocol}Btn`);
            const currentStatus = statusElement.textContent;
            
            if (currentStatus === 'Stopped') {
                log(`Starting ${protocol.toUpperCase()} server...`, 'info');
                sendMessage({
                    type: 'start_protocol_server',
                    protocol: protocol
                });
            } else {
                log(`Stopping ${protocol.toUpperCase()} server...`, 'info');
                sendMessage({
                    type: 'stop_protocol_server',
                    protocol: protocol
                });
            }
        }

        function updateStats() {
            document.getElementById('effectsSent').textContent = stats.effectsSent;
            document.getElementById('errorCount').textContent = stats.errors;
            const avgLatency = stats.effectsSent > 0 ? Math.round(stats.totalLatency / stats.effectsSent) : 0;
            document.getElementById('avgLatency').textContent = avgLatency + 'ms';
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
            log('Log cleared', 'info');
        }

        // Auto-connect on load if user wants
        window.addEventListener('load', () => {
            log('Control panel ready', 'success');
            // Uncomment to auto-connect:
            // setTimeout(connectToServer, 1000);
        });
    </script>
</body>
</html>
